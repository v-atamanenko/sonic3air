ifeq ($(strip $(VITASDK)),)
$(error "Please set VITASDK in your environment. export VITASDK=<path_to_vitasdk>")
endif

STATIC = 1

VITA_TITLE_ID   := SONIC3AIR
VITA_TITLE_NAME := Sonic 3 A.I.R.

export PATH := $(PATH):$(VITASDK)/bin

PREFIX := arm-vita-eabi-

CC        := $(PREFIX)gcc
CXX       := $(PREFIX)g++
AS        := $(PREFIX)as
AR        := $(PREFIX)ar
OBJCOPY   := $(PREFIX)objcopy
STRIP     := $(PREFIX)strip
NM        := $(PREFIX)nm
LD        := $(CC)
PKGCONFIG := $(PREFIX)pkg-config

ARCHFLAGS := -DARM -march=armv7-a -mfpu=neon -mfloat-abi=hard -D__vita__ -D__arm__
CFLAGS    += $(ARCHFLAGS) -g -O1 -fno-inline-functions \
	-fno-inline-functions-called-once -fno-optimize-sibling-calls -fno-default-inline -fno-short-enums -fsigned-char -mno-unaligned-access
ASFLAGS   := $(CFLAGS)
LDFLAGS   := -Wl,-q

VITA_LIBS := -lvitaGL -lvitashark -lmathneon -lSceDisplay_stub -lSceGxm_stub -lSceNet_stub \
	-lSceNetCtl_stub -lSceAppUtil_stub -lSceSysmodule_stub -lSceCtrl_stub -lSceHid_stub -lSceTouch_stub -lSceAudio_stub \
	-lSceShaccCgExt -ltaihen_stub -lSceKernelDmacMgr_stub \
	-lScePower_stub -lSceRtc_stub -lSceCommonDialog_stub -lScePgf_stub -lSceMotion_stub \
	-lSceFiber_stub -lSceMotion_stub -lSceAppMgr_stub -lstdc++ -lpthread -lpng -lz -lSceShaccCg_stub

LIBS += $(VITA_LIBS) -lm -lc

LIBPATHS += -L$(VITASDK)/arm-vita-eabi/lib
INCLUDES += -I$(VITASDK)/arm-vita-eabi/include

SUFFIX =    .elf
PKGSUFFIX = .vpk

$(OUTDIR)/$(NAME).velf: $(OUTDIR)/$(NAME)$(SUFFIX)
	vita-elf-create $< $@

$(OUTDIR)/eboot.bin: $(OUTDIR)/$(NAME).velf
	vita-make-fself -c -s $< $@

$(OUTDIR)/param.sfo: $(OUTDIR)/eboot.bin
	vita-mksfoex -s TITLE_ID=$(VITA_TITLE_ID) "$(VITA_TITLE_NAME)" -d ATTRIBUTE2=12 $(OUTDIR)/param.sfo

$(OUTDIR)/$(NAME).vpk: $(OUTDIR)/param.sfo
	vita-pack-vpk -s $(OUTDIR)/param.sfo -b $(OUTDIR)/eboot.bin "$(OUTDIR)/$(NAME).vpk"
	rm $(OUTDIR)/param.sfo $(OUTDIR)/$(NAME).velf
